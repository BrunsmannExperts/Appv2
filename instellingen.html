<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Instellingen</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/app.js"></script>
  <style>
    nav a {
      margin-right: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    .tabcontent {
      display: none;
      margin-top: 20px;
    }
    .tabcontent.active {
      display: block;
    }
  </style>
</head>
<body>
  <h1>Instellingen</h1>
  <nav>
    <a onclick="openTab('gebruikers')">Gebruikers</a>
    <a onclick="openTab('rapport')">Rapportstructuur</a>
    <a onclick="openTab('opmaak')">Opmaak</a>
    <a onclick="openTab('opslag')">Opslag</a>
    <a onclick="openTab('motoren')">Motordatabank</a>
  </nav>

  <div id="gebruikers" class="tabcontent">
    <h2>Gebruikersbeheer</h2>
    <p>(Reeds gebouwd, behouden)</p>
  </div>

  <div id="rapport" class="tabcontent">
    <h2>Excel Upload â€“ Rapportstructuur</h2>
    <input type="file" id="excelInput" accept=".xlsx" />
    <p><em>Selecteer een Excelbestand met kolommen als 'Hoofdstuk', 'Veldnaam', 'Toelichting', 'Type', 'Verplicht'.</em></p>
    <div id="previewTableContainer">
      <h3>Voorbeeld van ingelezen structuur:</h3>
      <table border="1" id="previewTable"><thead></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="opmaak" class="tabcontent">
    <h2>Opmaak & Thema</h2>
    <label>Kleur knoppen:<input type="color" id="kleur" value="#007bff"></label><br><br>
    <label>Tekstkleur:<input type="color" id="tekstkleur" value="#000000"></label><br><br>
    <label>Achtergrondkleur:<input type="color" id="achtergrond" value="#ffffff"></label><br><br>
    <label>Lettergrootte:<select id="lettergrootte">
      <option value="14px">Klein</option>
      <option value="16px" selected>Normaal</option>
      <option value="18px">Groot</option>
    </select></label><br><br>
    <label>Knopvorm:<select id="randen">
      <option value="0px">Hoekig</option>
      <option value="6px" selected>Afgerond</option>
      <option value="12px">Extra rond</option>
    </select></label><br><br>
    <button onclick="opslaanThema()">Opslaan</button>
  </div>

  <div id="opslag" class="tabcontent">
    <h2>Opslaginstellingen (Supabase)</h2>
    <label>Supabase Project URL:<br>
      <input type="text" id="supabaseUrl" style="width: 100%;">
    </label><br><br>
    <label>Supabase API Key:<br>
      <input type="password" id="supabaseKey" style="width: 100%;">
    </label><br><br>
    <label>Standaard opslagmap:<br>
      <input type="text" id="defaultFolder" value="rapporten/" style="width: 100%;">
    </label><br><br>
    <button onclick="opslaanOpslagInstellingen()">ğŸ’¾ Opslaan instellingen</button>
    <button onclick="checkOpslag()">ğŸ” Check verbinding</button>
    <p id="opslagStatus"></p>
  </div>

  <div id="motoren" class="tabcontent">
    <h2>Motordatabank â€“ Merken uploaden</h2>
    <p>Upload per merk een Excelbestand met motorgegevens. Kolommen: Motortype, Cilinders, PK, Brandstof, Opmerkingen.</p>
    <input type="file" id="motorbestand" accept=".xlsx" />
    <input type="text" id="merknaam" placeholder="Bijv. Yanmar" />
    <button onclick="slaMotorbestandOp()">ğŸ’¾ Opslaan merkbestand</button>
    <h3>ğŸ“‹ Ingeladen merken:</h3>
    <ul id="motormerkenlijst"></ul>
  </div>

  <script>
    function openTab(tabName) {
      document.querySelectorAll('.tabcontent').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
    }

    document.addEventListener("DOMContentLoaded", () => {
      openTab('gebruikers');
      laadOpslagInstellingen();
      laadThema();
      toonMotormerken();
    });

    function opslaanThema() {
      const theme = {
        primaryColor: document.getElementById("kleur").value,
        textColor: document.getElementById("tekstkleur").value,
        backgroundColor: document.getElementById("achtergrond").value,
        fontSize: document.getElementById("lettergrootte").value,
        borderRadius: document.getElementById("randen").value,
      };
      localStorage.setItem("theme", JSON.stringify(theme));
      location.reload();
    }

    function laadThema() {
      const theme = JSON.parse(localStorage.getItem("theme"));
      if (!theme) return;
      document.getElementById("kleur").value = theme.primaryColor;
      document.getElementById("tekstkleur").value = theme.textColor;
      document.getElementById("achtergrond").value = theme.backgroundColor;
      document.getElementById("lettergrootte").value = theme.fontSize;
      document.getElementById("randen").value = theme.borderRadius;
    }

    function opslaanOpslagInstellingen() {
      const instellingen = {
        url: document.getElementById("supabaseUrl").value,
        key: document.getElementById("supabaseKey").value,
        folder: document.getElementById("defaultFolder").value
      };
      localStorage.setItem("supabase_config", JSON.stringify(instellingen));
      alert("âœ… Opgeslagen!");
    }

    function laadOpslagInstellingen() {
      const config = JSON.parse(localStorage.getItem("supabase_config"));
      if (!config) return;
      document.getElementById("supabaseUrl").value = config.url || "";
      document.getElementById("supabaseKey").value = config.key || "";
      document.getElementById("defaultFolder").value = config.folder || "rapporten/";
    }

    async function checkOpslag() {
      const config = JSON.parse(localStorage.getItem("supabase_config"));
      if (!config?.url || !config?.key) {
        document.getElementById("opslagStatus").textContent = "âŒ Vul eerst de instellingen in.";
        return;
      }
      try {
        const response = await fetch(`${config.url}/rest/v1/`, {
          method: "GET",
          headers: {
            apikey: config.key,
            Authorization: "Bearer " + config.key
          }
        });
        if (response.ok) {
          document.getElementById("opslagStatus").textContent = "âœ… Verbonden met Supabase.";
        } else {
          document.getElementById("opslagStatus").textContent = "âŒ Geen verbinding mogelijk.";
        }
      } catch (err) {
        document.getElementById("opslagStatus").textContent = "âŒ Fout bij verbinden: " + err.message;
      }
    }

    function slaMotorbestandOp() {
      const merk = document.getElementById("merknaam").value.trim();
      const bestand = document.getElementById("motorbestand").files[0];
      if (!merk || !bestand) {
        alert("Vul een merknaam in en kies een bestand.");
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        const base64 = e.target.result.split("base64,")[1];
        localStorage.setItem("motorbestand_" + merk.toLowerCase(), base64);
        const huidige = JSON.parse(localStorage.getItem("motor_merken") || "[]");
        if (!huidige.includes(merk.toLowerCase())) {
          huidige.push(merk.toLowerCase());
          localStorage.setItem("motor_merken", JSON.stringify(huidige));
        }
        toonMotormerken();
        alert("âœ… Bestand opgeslagen voor merk: " + merk);
      };
      reader.readAsDataURL(bestand);
    }

    function toonMotormerken() {
      const lijst = document.getElementById("motormerkenlijst");
      lijst.innerHTML = "";
      const merken = JSON.parse(localStorage.getItem("motor_merken") || "[]");
      merken.forEach(m => {
        const li = document.createElement("li");
        li.textContent = m.charAt(0).toUpperCase() + m.slice(1);
        lijst.appendChild(li);
      });
    }
  </script>
</body>
</html>
